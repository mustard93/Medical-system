'use strict';define("WorkflowProcess",["JTopo","jQuery"],function(d,f){function g(a,b){this.options=b?f.extend(!0,{},h,b):f.extend(!0,{},h);b=a;"string"==typeof a&&(b=document.getElementById(a));this.canvas=b;a=new d.Stage(b);b=new d.Scene(a);b.background=this.options.scene.background;this.stage=a;this.scene=b;this.workflowTaskData=this.data=this.currentNode=null;this.options.data&&this.addWorkflowProcess(this.options.data)}var h={spacingWidth:80,spacingHeight:20,showStatus:!1,status:{strokeColor_doing:"153,153,153",strokeColor_done:"143,174,0",fillColor_ready:"229,229,229",fillColor_doing:"229,229,229",fillColor_done:"143,174,0",fontColor_regject_done:"255,255,255",fillColor_regject_done:"153,153,153"},data:null,scene:{background:""},node:{rejectNodefillColor:"153,153,153",rejectNodeFontColor:"255,255,255",clickCallback:null,fontColor:"0,0,0",image:"../images/logo.png"},link:{direction:"horizontal",image:"../images/logo.png"}};g.prototype={getNodesByName:function(a){var b=this.stage.childs[0].childs.filter(function(b){return b instanceof d.Node&&b.key==a});return b&&0<b.length?b[0]:null},getNodesByEventType:function(a){return this.stage.childs[0].childs.filter(function(b){return b instanceof d.Node&&b.data.type==a})},getLinkByKey:function(a){var b=this.stage.childs[0].childs.filter(function(b){return b instanceof d.Link&&b.key==a});return b&&0<b.length?b[0]:null},getAllLinks:function(){var a=this.stage.childs[0].childs.filter(function(a){return a instanceof d.Link});return a&&0<a.length?a:null},reload:function(a){a&&(this.data=a);console.log("reload");this.scene.clear();this.addWorkflowProcess(this.data)},addWorkflowProcess:function(a){this.scene.clear();if(a&&(this.data=a,a.events)){console.log("addWorkflowProcess.data\x3d");console.log(a);for(var b=0;b<a.events.length;b++)this.addEvent(a.events[b]);for(b=0;b<a.events.length;b++)this.addLinkByEvent(a.events[b]);a=d.layout.getRootNodes(this.scene.childs);console.log("JTopo.layout.TreeLayout");console.log(a);var c=this;require(["CanvasTreeLayout"],function(a){var b=c.getNodesByEventType("StartEvent");a.TreeLayout2(d,"right-center",c.options.spacingWidth,c.options.spacingHeight,b)(c.scene,c.scene.childs)})}},addWorkflowTaskData:function(a){a&&(this.workflowTaskData=a,console.log("addWorkflowTaskData.data\x3d"),console.log(a),this.showWorkflowTaskData())},showWorkflowTaskDataLinks:function(){var a=this.getAllLinks();if(a)for(var b=0;b<a.length;b++){var c=a[b];c.nodeA&&"done"==c.nodeA.status&&c.nodeZ&&("done"==c.nodeZ.status?c.strokeColor=this.options.status.strokeColor_done:"doing"==c.nodeZ.status&&(c.strokeColor=this.options.status.strokeColor_doing))}},showWorkflowTaskData:function(){if(this.workflowTaskData){var a=this.workflowTaskData.currentEvent;if(a)for(var b=0;b<a.length;b++){var c=this.getNodesByName(a[b].name);c&&(c.fillColor=this.options.status.fillColor_doing,c.status="doing")}if(a=this.workflowTaskData.eventRecords)for(b=0;b<a.length;b++)if(c=this.getNodesByName(a[b].event.name))"\u9a73\u56de"==c.data.conditionType?(c.fontColor=this.options.status.fontColor_regject_done,c.fillColor=this.options.status.fillColor_regject_done):c.fillColor=this.options.status.fillColor_done,c.status="done";this.showWorkflowTaskDataLinks()}},addLinkByEvent:function(a){var b=this.getNodesByName(a.name);if(b){if(a.sourceRef){var c=this.getNodesByName(a.sourceRef);c&&this.addLink(c,b,"horizontal","204,204,204")}a.targetRef&&(a=this.getNodesByName(a.targetRef))&&this.addLink(b,a,"horizontal","255,0,0");console.log(b)}},addLink:function(a,b,c,k){c||(c=this.options.link.direction);var f=a.text+"-"+b.text;if(!this.getLinkByKey(f)){var e=new d.FlexionalLink(a,b);e.bundleGap=15;e.arrowsRadius=15;e.key=f;e.nodeA=a;e.nodeZ=b;b.parentKey||(b.parentKey=[]);b.parentKey.push(a.key);e.direction=c;e.strokeColor=k;e.lineWidth=1;e.dashedPattern=2;this.scene.add(e);return e}},addStartNode:function(a){a=new d.Node(a);a.setSize(120,120);a.borderRadius=4;a.fillColor="143,174,0";return a},addNode:function(a){a=new d.Node(a);a.setSize(120,44);a.borderRadius=4;a.fillColor="110, 110, 255";return a},addEndNode:function(a){a=new d.Node(a);a.setSize(120,120);a.borderRadius=4;a.fillColor="238,187,45";return a},addNodeByEvent:function(a){var b;b=a.name;switch(a.type){case "StartEvent":b=this.addStartNode(b);break;case "EndEvent":b=this.addEndNode(b);break;default:b=this.addNode(b)}b.key=a.name;return b},addEvent:function(a){var b=this.addNodeByEvent(a);b.textPosition="Middle_Center";b.font="12px PingFangSC-Medium";b.data=a;this.options.showStatus&&(b.fillColor=this.options.status.fillColor_ready);this.scene.add(b);if(this.options.node.clickCallback){var c=this;b.addEventListener("dbclick",function(a){c.currentNode=this;c.options.node.clickCallback(a,c)})}return b}};return g});