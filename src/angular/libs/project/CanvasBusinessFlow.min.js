
/**
业务单流程图形展示
*/'use strict';define("CanvasBusinessFlow",["JTopo","jQuery"],function(e,f){function g(a,c){this.options=c?f.extend(!0,{},h,c):f.extend(!0,{},h);c=a;"string"==typeof a&&(c=document.getElementById(a));this.canvas=c;a=new e.Stage(c);c=new e.Scene(a);c.background=this.options.scene.background;this.stage=a;this.scene=c;this.workflowTaskData=this.data=this.currentNode=null;this.options.data&&this.addCanvasBusinessFlow(this.options.data)}var h={adaptHeight:!0,spacingWidth:20,spacingHeight:80,baseImageUrl:"../images/canvasBusinessFlow/",parentKeyName:"id",showStatus:!1,status:{strokeColor_doing:"90,195,0",strokeColor_done:"244,140,0",strokeColor_ready:"153,153,153",link_strokeColor_doing:"90,195,0",link_strokeColor_done:"90,195,0",link_strokeColor_ready:"153,153,153",link_dashedPattern_ready:5,link_dashedPattern_done:null,link_dashedPattern_doing:null,fillColor_ready:"229,229,229",fillColor_doing:"90,159,0",fillColor_done:"244,140,0",fontColor_regject_done:"255,255,255",fillColor_regject_done:"153,153,153"},data:null,scene:{background:""},node:{rejectNodefillColor:"153,153,153",rejectNodeFontColor:"255,255,255",clickCallback:null,fontColor:"0,0,0",image:"../images/logo.png"},link:{direction:"horizontal",image:"../images/logo.png"}};g.prototype={getEventByKey:function(a){var c=this,b=this.stage.childs[0].childs.filter(function(b){return b instanceof e.Node&&b.data[c.options.parentKeyName]==a});return b&&0<b.length?b[0]:null},getLinkByKey:function(a){var c=this.stage.childs[0].childs.filter(function(b){return b instanceof e.Link&&b.key==a});return c&&0<c.length?c[0]:null},getAllLinks:function(){var a=this.stage.childs[0].childs.filter(function(a){return a instanceof e.Link});return a&&0<a.length?a:null},reload:function(a){a&&(this.data=a);console.log("reload");this.scene.clear();this.addCanvasBusinessFlow(this.data)},addCanvasBusinessFlow:function(a,c){this.scene.clear();if(a&&(this.data=a,this.curRelId=c,a.events)){for(c=0;c<a.events.length;c++)this.addEvent(a.events[c]);for(c=0;c<a.events.length;c++)this.addLinkByEvent(a.events[c]);e.layout.getRootNodes(this.scene.childs);this.showWorkflowTaskDataLinks();var b=this;require(["CanvasTreeLayout"],function(a){a=a.TreeLayout2(e,"right",b.options.spacingWidth,b.options.spacingHeight)(b.scene,b.scene.childs);b.options.adaptHeight&&a&&0<a.y&&(b.canvas.height=a.y)})}},showWorkflowTaskDataLinks:function(){var a=this.getAllLinks();if(a)for(var c=0;c<a.length;c++){var b=a[c];b.strokeColor=this.options.status.link_strokeColor_ready;b.dashedPattern=this.options.status.link_dashedPattern_ready;b.nodeA&&b.nodeA.data&&"\u5b8c\u6210"==b.nodeA.data.status&&b.nodeZ&&("\u5b8c\u6210"==b.nodeZ.data.status?(b.strokeColor=this.options.status.link_strokeColor_done,b.dashedPattern=this.options.status.link_dashedPattern_done):"\u6267\u884c\u4e2d"==b.nodeZ.data.status&&(b.strokeColor=this.options.status.link_strokeColor_doing,b.dashedPattern=this.options.status.link_dashedPattern_doing))}},addLinkByEvent:function(a){var c=this.getEventByKey(a[this.options.parentKeyName]);if(c){if(a.sourceRef){var b=this.getEventByKey(a.sourceRef);b&&this.addLink(b,c)}a.targetRef&&(a=this.getEventByKey(a.targetRef))&&this.addLink(c,a)}},addLink:function(a,c,b){b=a.data[this.options.parentKeyName]+"-"+c.data[this.options.parentKeyName];if(!this.getLinkByKey(b)){var d=new e.FlexionalLink(a,c);d.arrowsRadius=15;d.key=b;d.nodeA=a;d.nodeZ=c;a.key=a.data[this.options.parentKeyName];c.parentKey||(c.parentKey=[]);c.parentKey.push(a.key);d.direction=this.options.link.direction;d.strokeColor="204,204,204";d.lineWidth=1;d.dashedPattern=this.options.status.link_dashedPattern_ready;this.scene.add(d);return d}},addNodeByEvent:function(a){var c=!1,b=this.getEventByKey(a.id);b||(c=!0,b=new e.Node(a.name));b.data=a;b.setSize(120,44);b.borderRadius=4;b.fillColor="110, 110, 255";b.textPosition="Bottom_Center";b.text=a.name;b.font="12px PingFangSC-Medium";b.fontColor=this.options.node.fontColor;var d="icon-"+a.moduleType;"outstockOrder"==a.moduleType?"\u9500\u552e\u51fa\u5e93\u5355_\u7ea2\u5b57"==a.subModuleAttribute&&(d+="-hongzi"):"instockOrder"==a.moduleType&&"\u91c7\u8d2d\u5165\u5e93\u5355_\u7ea2\u5b57"==a.subModuleAttribute&&(d+="-hongzi");this.curRelId&&this.curRelId==b.data.relId?(b.fontColor=this.options.status.strokeColor_doing,d+="-active"):"\u5b8c\u6210"==b.data.status?(b.fontColor=this.options.status.strokeColor_done,d+="-done"):"\u6267\u884c\u4e2d"==b.data.status?(b.fontColor=this.options.status.strokeColor_done,d+="-done"):(b.fontColor=this.options.status.strokeColor_doing,d+="-null");b.setImage(this.options.baseImageUrl+d+".png",!0);c&&this.scene.add(b);return b},addEvent:function(a){a=this.addNodeByEvent(a);if(this.options.node.clickCallback){var c=this;a.addEventListener("click",function(a){c.currentNode=this;c.options.node.clickCallback(a,c)})}return a}};return g});