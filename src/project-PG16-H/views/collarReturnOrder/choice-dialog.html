<div class="modal-content pr-modal-content right-side-new pr-bg-black4 more-stock"
     ng-controller="collarReturnOrderChoiceDialogCtrl"
     ajax-url=""
     scope-data="stockBatchList"
     ng-init="listParams={};angucomplete_data={};"
     style="position: relative"
     callback="initFlag=true;$root.reloadTime=$root.utils.getNowTime();getChoisedBatchsId(dialogData.choisedBatchList);"
>

    <!--dialogData:{{dialogData}}-->

    <style>

        .tab a {
            display: block;
            width: 150px;
            float: left;
            height: 100%;
            margin: 0;
            padding: 0;
            border-bottom: #C7A77B solid 1px;
            border-right: #C7A77B solid 1px;
            margin-top: -1px;
        }

        .tab a.cur {
            color: white;
            background: #443F3A;
            border-bottom: #443F3A solid 1px;
        }

        .goods-info {
            margin: 15px 20px;
        }

        .goods-info .color-6 {
            font-size: 12px;
            color: #999999;
            line-height: 16px;
            width: 40%;
            display: inline-block;

        }

        .goods-info .color-6 i {
            color: white;
            font-style: normal;

        }

        .line-dotted {
            height: 2px;
            margin: 10px 0;
            width: auto;
            border-bottom: dashed rgba(255, 255, 255, 0.26) 1px;
        }

        .order-list {
            width: auto;
            margin: 15px;
            height: 570px;
            overflow: auto;
        }

        .order-list li {
            width: 33%;
            float: left;
            cursor: pointer;
            padding-top: 5px;
        }

        .order-list li .mgb-xxl:hover,.order-list li .mgb-xxl.on {
            -webkit-box-shadow: 0 0 10px #ff8c00;
            -moz-box-shadow: 0 0 10px #ff8c00;
            box-shadow: 0 0 10px #ff8c00;
        }

        .order-list li .pr-bg-grey2 {
            background: #ddd;
        }

        .footer-btn-box {
            height: 56px;
            z-index: 1000;
            position: absolute;
            right: 0;
            left: 0;
            bottom: 0;
            text-align: center;
            background: rgba(54, 48, 44, 0.95);
        }

        .footer-btn {
            border: 0;
            height: 36px;
            width: 160px;
            background: #C7A77B;
            border-radius: 100px;
            font-size: 14px;
            color: #FFFFFF;
            line-height: 18px;
            margin: 10px 30px;
        }

        .choiced {
            width: 25px;
            height: 25px;
            line-height: 25px;
            background: #C7A77B;
            color: #fff;
            border-radius: 50%;
            text-align: center;
            font-size: 20px;
            position: absolute;
            left: 10px;
        }


        /* 重写样式- 药械闪加*/
        p.mgb{
            display: none;
        }
       input.pr-w-100{
            width: 300px!important;
        }

    </style>

    <!-- 标题 -->
    <div class="bb-line-gold pr-bg-black2 min-h-l">

        <h1 ng-init="type='通过商品退货'" class="pr-indent-20 pdb-m text-n tab" style="line-height:50px;max-height:35px;">

            <a ng-click="type='通过商品退货'" ng-class="{'cur':type=='通过商品退货'}">通过商品退货</a>

            <a ng-click="type='通过领用单退货'" ng-class="{'cur':type=='通过领用单退货'}">通过领用单退货</a>

        </h1>
    </div>

    <div ng-if="type=='通过领用单退货'">

        <!-- 过滤条件 -->
        <div class="pdt-s pdb-s pd-c-xl">
            <div class="" style="margin: 10px 0">
                <span class="color-12">选择商品关联的领用单</span>
            </div>

            <!-- 关键字过滤 -->
            <div class="inline-block">
                <div class="order-list-search text-left code pos-rel-tr inline-block fl-r">
                    <input type="text"
                           class="ipt pdr-xxl relative"
                           placeholder="领用单编号"
                           ng-model="orderCode"
                           ng-change="getByOrderCode(orderCode)">
                    <i class=""></i>
                </div>
            </div>

        </div>
        <div class="pdt-s pdb-s pd-c-xl">
            <div class="inline-block" style="margin: 10px 0">
                <span class="color-12">选择商品关联的领用单</span>
            </div>
        </div>



        <div ng-if="!scopeData" class="empty-table clearfix">
            <div>&nbsp;</div>
            <div>&nbsp;</div>
            <div>&nbsp;</div>
        </div>

        <div class="" ng-if="scopeData">
            <div class="panel pr-panel pr-fuzzy-boundary pr-panel-height mgb-l pd-n">
                <!-- 单据信息 -->
                <div class="flex-column color-9 pd-c-l pdt-m pdb-m bb-dashed-line">
                    <div class="flex-item-6">
                        <span class="mgr">领用单编号：<em class="color-3">{{scopeData.orderCode ||  '暂无'}}</em></span>
                        <span class="mgr">审核人：<em class="color-3">{{scopeData.approver.approverUser.n || '暂无'}}</em></span>
                        <span class="mgr relative">制单人：
                            <span class="purchaseorder-buyer-info-outside">
                              <strong run-popovers class="color-custom-orange cur-pot text-normal pr-color"
                                      style="position:relative;height:25px;">{{scopeData.inputUser.n}}</strong>
                              <span class="purchaseorder-buyer-info" style="right:-73px">
                                <i class="block bb-line pdb-s text-normal"><em class="fa fa-mobile-phone mgl text-m"></em><em class="inline-block pdl pdr pdt">{{scopeData.inputUser.p}}</em></i>
                                <i class="block pdb-s text-normal">
                                  <em class="fa fa-comment-o mgl"></em>
                                  <em class="inline-block pdl pdr pdt">
                                    <a href="javascript:;"
                                       modal-center="340"
                                       modal-data='{"toUser":{"n":"{{scopeData.inputUser.n}}"},"userIds":["{{scopeData.inputUser.id}}}"]}'
                                       modal-url="views/notice/sendToUser.html">发送消息
                                    </a>
                                  </em>
                                </i>
                              </span>
                            </span>
                          </span>

                    </div>
                    <div class="flex-item-6 text-right">
                        <span class="mgr">录单日期：<em class="color-3">{{scopeData.createAt | date:'yyyy-MM-dd'}}</em></span>
                        <span class="mgr">状态：<em class="color-3">{{scopeData.orderStatus}}</em></span>
                    </div>
                </div>
                <!-- 类别选择 -->
                <div class="pd-c-l pdt-m pdb-m color-9">
                    <div class="pd-c-l pdt-m pdb-m color-9">
                        <span class="mgr-l">申请人：<em class="color-3">{{scopeData.applicant.n || '暂无'}}</em></span>
                        <span class="mgr-l">申请部门：<em class="color-3">{{scopeData.departmentName || '暂无'}}</em></span>
                        <span class="mgr-l">领用日期：<em class="color-3">{{scopeData.createAt | date:'yyyy-MM-dd'}}</em></span>
                        <span class="mgr-l">领用库房：<em class="color-3">{{scopeData.expectDate | date:'yyyy-MM-dd'}}</em></span>
                    </div>
                </div>
                <!-- 商品列表 -->
                <div class="outside-table-d">
                    <table class="table pr-table pr-new-table mgb-n" style="min-width: 100%;">
                        <thead>
                        <tr>
                            <th class="w-60 text-center mycheck" ng-if="!listParams.shelvesUpStatus">
                                <input type="checkbox" class="selectAll cur-pot" id='1' ng-init="isChoiseAll=false" ng-model="isChoiseAll" ng-click="handleChoiseAllEvent(isChoiseAll,scopeData.orderMedicalNos);">
                                <label for="1" style="top: 10px;"></label>
                            </th>
                            <th class="text-center">序号</th>
                            <th class="text-center">商品编码</th>
                            <th class="text-left">商品名称</th>
                            <th class="text-center">申请数量</th>
                            <th class="text-center">领用数量</th>
                            <th class="text-center">可退数量</th>
                            <th class="text-center">商品规格</th>
                            <th class="text-center">基本单位</th>
                            <th class="text-center">产地</th>
                            <th class="text-center">生产厂商</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- ngRepeat: tr in scopeData.orderMedicalNos -->
                        <tr ng-repeat="tr in scopeData.orderMedicalNos" class="ng-scope">
                            <td ng-init="tr.handleFlag = tr.handleFlag ? true : false" class="select-td text-center mycheck" style="width: 100px;">
                                <input type="checkbox"
                                       ng-disabled="itemInArray(tr.onlyId,formData.orderMedicalNos,'onlyId')"
                                       class="selectOne cur-pot" id='{{$index+2}}' ng-model="tr.handleFlag" ng-click="handleItemClickEvent(tr);">
                                <label for="{{$index+2}}"></label>
                            </td>
                            <td class="text-center" style="line-height:2.4">{{$index+1}}</td><!-- 序号 -->
                            <td class="text-center" style="line-height:2.4">{{tr.code}}</td><!-- 商品编码 -->
                            <td class="text-left" style="line-height:2.4">
                                <div class="autocut" title="{{tr.name}}">
                                    {{tr.name}}
                                </div>
                            </td><!-- 商品全名 -->
                            <td class="text-right" style="line-height:2.4">{{tr.applicationCount}}</td><!-- 申请数量 -->
                            <td class="text-right" style="line-height:2.4">{{tr.availableCount}}</td><!-- 领用数量 -->
                            <td class="text-right">{{tr.returnTotal}}</td><!-- 可退数量 -->
                            <td class="text-center" style="line-height:2.4">{{tr.specificationAndModelType}}</td><!-- 商品规格 -->
                            <td class="text-center" style="line-height:2.4">{{tr.packingAttribute.name}}</td><!-- 商品单位 -->
                            <td class="text-center" >{{tr.productionPlace}}</td>
                            <td class="text-center" >{{tr.manufacturer}}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <div class="footer-btn-box">
            <button ng-click="addOrderDataToList();modal.close()" class="footer-btn">确定</button>
        </div>

    </div>

    <div ng-if="type=='通过商品退货'">

        <div ng-show="!showBatchs">

            <div class="bb-line-gold pdt-s pdb-s pd-c-xl">
                <div class="inline-block">
                    <span class="color-12">选择需要退货的商品</span>
                </div>

                <div class="pdt-s pdb-s pd-c-xl">

                    <div class="angucomplete-holder">
                        <!-- 屏蔽失去焦点隐藏下拉框的ng-blur事件，为实现点击已冻结药品时下拉框不消失的功能 -->
                        <!--<span angucomplete-medical placeholder="输入" title-field="商品名称"-->
                              <!--url="rest/authen/medicalStock/query" class="inline-block"-->
                              <!--ng-model="angucomplete_data"-->
                              <!--add-data-callback-fn="flashAddDataCallbackFn(angucomplete_data);"-->
                        <!--&gt;</span>-->
                        <!-- ngIf: showDropdown -->

                        <!--<span angucomplete-medical placeholder="商品名称"     title-field="name"-->
                              <!--url="rest/authen/medicalStock/query" class="inline-block"-->
                              <!--ng-model="angucomplete_data"-->
                              <!--add-data-callback-fn="flashAddDataCallbackFn"-->
                        <!--&gt;</span>-->


                        <div style="width: 300px;">


                            <div class="pd-c-l pdt-m"
                                 flash-add-medical
                                 ng-model="data1"
                                 placeholder="药品名称"
                                 hide-title
                                 hide-add-button
                                 hide-quantity
                                 hide-import
                                 ajax-url="rest/authen/medicalStock/query"
                                 add-data-callback-fn="flashAddDataCallbackFn">
                            </div>
                        </div>




                    </div>

                    <div class="goods-info">
                        <span class="color-6">生产厂家：<i>{{angucomplete_data.data.data.manufacturer}}</i></span>
                        <span class="color-6">商品编号：<i>{{angucomplete_data.data.data.code}}</i></span>
                    </div>

                    <div class="goods-info">
                        <span class="color-6">商品规格：<i>{{angucomplete_data.data.data.specificationAndModelType}}</i></span>
                        <span class="color-6">商品单位：<i>{{angucomplete_data.data.data.packingAttribute.name}}</i></span>
                    </div>

                </div>
            </div>

            <!-- 过滤条件 -->
            <div  class="pdt-s pdb-s pd-c-xl">
                <div class="inline-block" style="margin: 10px 0">
                    <span class="color-12">选择商品关联的领用单</span>
                </div>
                <br/>

                <div ng-if="angucomplete_data.data.id">

                    <!-- 仓库过滤 -->
                    <div  class="inline-block">
                        <span class="color-9">领用部门：</span>
                        <select
                                class="ipt pr-short-ipt color-3"
                                style="width:90px;"
                                data-placeholder=""
                                default-empty="全部"
                                width="120px"
                                chosen
                                ng-model="listParams.storeRoomId"
                                select-source="rest/authen/department/queryForSelectOption"
                                ng-change="handleSearchFilter(listParams,angucomplete_data.data.id)">
                        </select>
                    </div>

                    <!-- 领用库房 -->
                    <div class="inline-block" style="margin: 0 20px;">
                        <span class="color-9">领用库房：</span>
                        <select
                                class="ipt pr-short-ipt color-3"
                                style="width:90px;"
                                data-placeholder=""
                                default-empty="全部"
                                width="120px"
                                chosen
                                ng-model="listParams.departmentId"
                                select-source="rest/authen/storeRoom/queryForSelectOption"
                                ng-change="handleSearchFilter(listParams,angucomplete_data.data.id)">
                        </select>
                    </div>


                    <!-- 关键字过滤 -->
                    <div class="inline-block">
                        <span class="color-9">领用单编号：</span>
                        <div class="order-list-search text-left code pos-rel-tr inline-block fl-r">
                            <input type="text"
                                   class="ipt pdr-xxl relative"
                                   placeholder="领用单编号"
                                   ng-model="listParams.q"
                                   ng-change="handleSearchFilter(listParams,angucomplete_data.data.id)">
                            <i class="" style=""></i>
                        </div>
                    </div>

                    <div class="line-dotted"></div>

                    <!-- 仓库过滤 -->
                    <div class="inline-block" style="margin-right: 8px;">
                        <span class="color-9">申 请 人 ： </span>
                        <select
                                class="ipt pr-short-ipt color-3"
                                style="width:90px;"
                                data-placeholder=""
                                default-empty="全部"
                                width="120px"
                                chosen
                                ng-model="listParams.storeRoomId"
                                select-source="rest/authen/organizationAndUser/queryForSelectOption?departmentId={{listParams.departmentId}}"
                                ng-change="handleSearchFilter(listParams,angucomplete_data.data.id)">
                        </select>
                    </div>

                    <!-- 日期过滤 -->
                    <div class="inline-block relative">
                        <span class="color-9 mgl-m">领用日期：</span>
                        <div class="date-icon-outside" ng-if="!listParams.createAtBeg">
                            <input type="text"
                                   datepicker
                                   class="ipt-date pr-short-ipt color-6 mgr-s pr-indent-10"
                                   ng-readonly="true"
                                   ng-model="listParams.createAtBeg"
                                   placeholder=""
                                   ng-change="handleSearchFilter(listParams,dialogData.id)">
                            <span class="date-icon"></span>
                        </div>
                        <div class="date-icon-outside" ng-if="listParams.createAtBeg">
                            <input type="text"
                                   datepicker
                                   class="ipt-date pr-short-ipt color-6 mgr pr-indent-10"
                                   ng-readonly="true"

                                   ng-model="listParams.createAtBeg">
                            <span class="delete-date-icon" style="z-index:11;" ng-click="listParams.createAtBeg='';"></span>
                        </div>
                        <span class="color-9">至</span>
                        <div class="date-icon-outside" ng-if="!listParams.createAtEnd">
                            <input type="text"
                                   datepicker
                                   class="ipt-date pr-short-ipt color-6 mgr-l pr-indent-10"
                                   ng-readonly="true"
                                   ng-model="listParams.createAtEnd"
                                   placeholder=""
                                   ng-change="handleSearchFilter(listParams,dialogData.id)">
                            <span class="date-icon"></span>
                        </div>
                        <div class="date-icon-outside" ng-if="listParams.createAtEnd">
                            <input type="text"
                                   datepicker
                                   class="ipt-date pr-short-ipt color-6 mgr pr-indent-10"
                                   ng-readonly="true"

                                   ng-model="listParams.createAtEnd"/>
                            <span class="delete-date-icon" style="z-index:11;" ng-click="listParams.createAtEnd='';"></span>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 领用单列表 -->
            <div  ng-show="!showBatchs" class="color-red text-n pdl-l pdt-m text-center">
                <sapn ng-if="!orderList.length">此商品暂无领用单信息...</sapn>
            </div>


            <!--领用单列表-->
            <div class="order-list">
                <ul ng-if="orderList.length" class="li-min-h">

                    <!--ng-class="{'pr-bg-grey2':(tr.orderStatus=='已作废')}"-->

                    <li class="pdr-m pdl-m relative confirm-order-list ng-scope"  ng-repeat="tr in orderList track by $index">
                        <div ng-click="choiceThis(tr,$index); " class="mgb-xxl pr-bg-white pr-fuzzy-boundary relative"
                             ng-class="{'on': index == $index }"
                        >
                            <div class="card-new">
                                <div class="bt-line">
                                    <div ng-if="index == $index" class="choiced"><img src="../images/icon-checked.png" alt=""></div>
                                    <h1 class="text-center text-m color-3 text-ellips-s ng-binding">{{tr.departmentName}}</h1>
                                </div>

                                <div class="flex-column qurey text-s color-9 bt-dashed-line">
                                    <span class="flex-item-6">领用单号</span>
                                    <span class="flex-item-6 text-right pr-indent-10 autocut-default" title="3423fsdgsdah">
                                <strong class="color-black text-normal ng-binding">{{tr.relOrderCode}}</strong>
                              </span>
                                </div>
                                <div class="flex-column qurey text-s color-9 bt-dashed-line">
                                    <span class="flex-item-6">领用库房</span>
                                    <span class="flex-item-6 text-right pr-indent-10 autocut-default" title="3423fsdgsdah">
                                        <strong class="color-black text-normal ng-binding">{{tr.storeRoomName}}</strong>
                                      </span>
                                </div>
                                <div class="flex-column qurey text-s color-9 bt-dashed-line">
                                    <span class="flex-item-6 text-left">领用日期</span>
                                    <span class="flex-item-6 text-right">
                                  <strong class="color-black text-normal ng-binding">{{tr.expectDate |date :'yyyy-MM-dd' }}</strong>
                              </span>
                                </div>
                                <div class="flex-column qurey text-s color-9 bt-dashed-line">
                                    <span class="flex-item-6 text-left">申请人</span>
                                    <!-- <span class="flex-item-6 text-right"> -->
                                    <span class="flex-item-6 text-right purchaseorder-buyer-info-outside">
                                  <strong run-popovers=""
                                          class="color-custom-orange cur-pot text-normal pr-color ng-binding"
                                          style="position:relative;height:25px;">{{tr.applicant.n}}</strong>
                                </span>
                                    <!-- <strong class="color-black text-normal">{{tr.applicant.n || '暂无'}}</strong>
                                </span> -->
                                </div>

                            </div>
                        </div>
                    </li>

                </ul>
                <!-- 导航 -->
                <div class="clearfix" ng-if="tbodyList.length">
                    <div class="fr">
                        <pagination status="status"></pagination>
                    </div>
                </div>
            </div>
            <div class="footer-btn-box">
                <button ng-click="getGoodsBatchs();" class="footer-btn">下一步</button>
            </div>
        </div>


        <div ng-show="showBatchs">

            <div class="bb-line-gold pr-bg-black2 min-h-l">
                <h1 class="pr-indent-20 pdb-m text-n" style="line-height:50px;max-height:35px;">选择生产批号 - {{curOrder.medicalNo.name}}</h1>
            </div>
            <!-- 批次信息 -->
            <div style="margin: 10px;">
                <table class="full-width another-table">
                    <thead>
                    <tr class="bb-line-gold">
                        <th class="w-60 text-center mycheck" style="width: 100px;">
                            <input type="checkbox" class="selectAll cur-pot" id='1' ng-init="isChoiseAll=false" ng-model="isChoiseAll" ng-click="handleChoiseAllEvent(isChoiseAll,stockBatchList);">
                            <label for="1" style="top: 10px;"></label>
                        </th>
                        <th>生产批号</th>
                        <th>有效期至</th>
                        <th>可退量</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!--ng-class="{ 'pr-bg-grey3':choisedBatchsIdList.indexOf(item.id)!==-1 }"-->

                    <tr ng-repeat="item in stockBatchList" class="trHover-bg">

                        <td ng-init="item.handleFlag= item.handleFlag ?  true : false" class="select-td text-center mycheck" style="width: 100px;">
                            <input type="checkbox" ng-disabled="$index==4" class="selectOne cur-pot" id='{{$index+2}}' ng-model="item.handleFlag" ng-click="handleItemClickEvent(item);">
                            <label for="{{$index+2}}"></label>
                        </td>

                        <td class="text-left" style="height:50px;"> {{item.productionBatch}}</td><!--生产批号-->
                        <td class="" style="height:50px;">{{item.validTill | date:'yyyy-MM-dd'}}</td><!--有效期至-->
                        <td class="text-left" style="height:50px;">{{item.pickNo}}</td><!--可退量-->
                    </tr>
                    </tbody>
                </table>
                <div class="footer-btn-box">
                    <button ng-click="showBatchs=!showBatchs" class="footer-btn">上一步</button>
                    <!--<button class="footer-btn">下一步</button>-->

                    <button ng-click="addToList();showBatchs=!showBatchs;" class="footer-btn">确定并继续</button>

                    <button ng-click="addToList();modal.close()" class="footer-btn">确定</button>

                </div>
            </div>

        </div>

    </div>
</div>
