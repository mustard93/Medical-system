<div class="salesOrder-edit"
     ng-controller="salesOrderEditCtrl2"
     ajax-url="rest/authen/salesOrder/getOfEdit.json?id={{mainStatus.pageParams.id}}&copyId={{mainStatus.pageParams.copyId}}"
     scope-data="formData"
     callback="initFlag=true;watchFormChange('formData')"
     alert-error>

  <form id="editForm"
        name="editForm"
        form-validator
        parameter-body
        action="rest/authen/salesOrder/save.json"
        alert-error
        alert-ok
        scope-error-msg="errorMsg"
        scope-data="formData"
        callback="submitFormAfter();watchFormChange('formData')">
    <!-- 头部信息 -->
    <div class="relative bb-line">
      <div class="pd-l">
        <!-- 标题 -->
        <div class="mgb-m">
          <p class="mgb-m">销售中心 / <em class="color-custom-orange">购需单</em></p>
          <h1 class="pr-font-22 pr-color">新建购需单</h1>
        </div>
        <!-- 客户列表 -->
        <div class="">
          <select ng-if="initFlag"
                  class="ipt pr-long-ipt color-6"
                  data-placeholder="客户名"
                  chosen
                  chosen-ajax
                  ng-model="formData.customerId"
                  select-source="rest/authen/customerAddress/queryForSelectOption.json">
          </select>
        </div>
      </div>
    </div>
    <!-- 药械列表 -->
    <div class="pd-l">
      <div class="panel pr-panel pr-fuzzy-boundary pr-panel-height mgb pd-c-l" auto-get-focus="salesOrderQuantity">
        <!-- 信息 -->
        <div class="bb-dashed-line">
          <h1 class="text-bold">药械闪加</h1>
          <div class="mgb">
            <span angucomplete-medical
                  placeholder="商品名 商品简称 商品名头字母 商品编号 厂家名 厂家名头字母。多个关键字段，用空格分隔"
                  title-field="name"
                  url="http://localhost:3000/src/angularjs-api/data/medicalStockList.json"
                  ng-model="angucomplete_data"
                  class="inline-block mgr medical-search"
                  ng-change="addDataItem=angucomplete_data.data;addDataItem.relId=angucomplete_data.id">
            </span>
            <span class="mgr medical-num inline-block">
              <input id="salesOrderQuantity" type="number" class="ipt pr-w-100" ng-model="addDataItem.csmQuantity" ng-keyup="handleAddThisItem($event)" placeholder="数量" />
            </span>
            <span class="mgr">
              <a href="" ng-click="newAddDataItemClick(addDataItem,medical);" class="add-medical-list" title="添加药械"></a>
            </span>
            <span class="mgr">
              <a href="#" class="import-medical-list">导入药械清单</a>
            </span>
          </div>
          <p class="mgb">
            <span class="mgr-m">{{addDataItem.manufacturer || '生产商名'}}</span>
            <span>{{addDataItem.specification || '规格'}}</span>
          </p>
        </div>
        <!-- 列表 -->
        <div class="pd-v-s">
          <p class="flex-column mgb">
            <span class="flex-item-6">购需单号：<em>{{formData.orderNo || '暂无'}}</em></span>
            <span class="flex-item-6 text-right">状态：<em>未提交</em></span>
          </p>
          <table class="table pr-table table-hover">
            <thead>
              <tr>
                <th class="text-center">商品编号</th>
                <th class="text-left">商品全名</th>
                <th class="text-center">规格型号</th>
                <th class="text-center">单位</th>
                <th class="text-center">数量</th>
                <th class="text-center">含税单价</th>
                <th class="text-center">税率</th>
                <th class="text-center">折扣额</th>
                <th class="text-center">折扣率</th>
                <th class="text-center">无税单价</th>
                <th class="text-center">无税金额</th>
                <th class="text-center">税额</th>
                <th class="text-center">价税合计</th>
              </tr>
            </thead>
            <tbody class="bg-white">
              <tr ng-repeat="tr in formData.orderMedicalNos" salesorder-edit-show-delbtn ng-init="orderMedicalNoIds.push(tr.relId)" ng-controller="SalesOrderDetailsController">
                <td class="text-center">{{tr.code}}</td>
                <td class="text-left">{{tr.name}}</td>
                <td class="text-center">{{tr.specification}}</td>
                <td class="text-center">{{tr.unit}}</td>
                <td class="text-center">
                  <div class="order-goods-num">
                    <button type="button" class="inline-block left" ng-click="tr.quantity=tr.quantity-1" ng-disabled="tr.quantity==1">-</button>
                    <span class="inline-block">
                      <input type="number"
                             class="inline pr-table-input text-center item-quantity"
                             style="width:60px;"
                             ng-model="tr.quantity"
                             ng-class="{'pr-bg-pink': medicalStockMap[tr.relId].quantity<tr.quantity}">
                    </span>
                    <button type="button" class="inline-block right" ng-click="tr.quantity=tr.quantity+1">+</button>
                  </div>
                </td>
                <td class="text-center">
                  ￥ <input type="text" class="ipt pr-ipt-60 text-right" ng-model="tr.price">
                </td>
                <td class="text-center" ng-init="tr.taxRate='0.17'">
                  <!-- <input type="text" class="ipt pr-ipt-60 text-right" ng-model="tr.taxRate"> -->
                  <select ng-model="tr.taxRate" class="select pr-select pr-select-sm" style="width:60px;">
                    <option value="0.17" ng-selected="true">17%</option>
                    <option value="0.03">3%</option>
                  </select>
                </td>
                <td class="text-center" ng-init="tr.discountPrice='0'">
                  ￥ <input type="text" class="ipt pr-ipt-60 text-right" ng-model="tr.discountPrice">
                </td>
                <td class="text-center" ng-init="tr.discountRate='100'">
                  <input type="text" class="ipt pr-ipt-60 text-right" ng-model="tr.discountRate">%
                </td>
                <td class="text-center">￥{{tr.price*(1-tr.taxRate)-tr.discountPrice | number:2}}</td>
                <td class="text-center">￥{{tr.price*(1-tr.taxRate)*tr.quantity-tr.discountPrice*tr.quantity | number:2}}</td>
                <td class="text-center">￥{{tr.price*tr.taxRate-tr.discountPrice | number:2}}</td>
                <td class="text-center relative">￥{{tr.price*tr.quantity-tr.discountPrice*tr.quantity | number:2}}
                  <div class="sales-order-item-delbtn">
                    <div class="sales-order-del-btn"><a href="javascript:;"></a></div>
                    <div class="bg-white">
                      <p class="bb-line color-red pd-v-s">确认删除本条数据?</p>
                      <p class="pd-v-s">
                        <a href="" ng-click="return;">取消</a>
                        <button class="btn btn-primary pr-btn-xsm pr-btn-bg-gold mgl"
                                ng-click="formData.orderMedicalNos.splice($index,1);formData.totalPrice=formData.totalPrice-tr.strike_price*tr.quantity">确认
                        </button>
                      </p>
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- 其他信息 -->
    <div class="relative" style="margin-bottom:60px;">
      <div class="pd-c-l">
        <!-- 发货方信息 -->
        <div class="panel pr-panel pr-fuzzy-boundary pr-panel-height mgb">
          <header class="text-n text-bold">发货方信息
            <span class="tools pull-right">
              <a href="javascript:;" class="fa fa-chevron-down" toggle-panel></a>
            </span>
          </header>
          <!-- <div class="panel-body" style="display:none;">
            <div class="mgb-l">
              <select ng-if="formData.createAt"
                      class="ipt pr-long-ipt"
                      data-placeholder="采购方名称"
                      chosen
                      width="280px"
                      ng-model="formData.customerId"
                      select-source="rest/authen/purchaserAddress/queryForSelectOption.json">
              </select>
            </div>
            <div class="consignee-info"
                 ajax-if-eval="formData.customerId"
                 ajax-url="rest/authen/purchaserAddress/get.json?id={{formData.customerId}}&t={{reloadTime}}"
                 scope-data="purchaserAddress"
                 callback="customerAddressGetCallBack(formData,purchaserAddress)"
                 ng-class="{'static': purchaserAddress.contacts}">
              <h1 class="color-9 text-n mgb">收货人信息</h1>
              <ul ng-if="formData.customerId" style="min-height:136px;">
                <li class="mgr-m mgb-m" style="min-height:136px;"  ng-repeat="item in purchaserAddress.contacts" ng-click="formData.contactsId=item.id">
                  <p class="pdb">{{item.name}} </p>
                  <p class="text-n color-6 mgb-s">{{item.prov}} {{item.city}} {{item.area}} {{item.address}} {{item.tel}}</p>
                  <p><a href="javacript:;"  modal-right="600" modal-data='{"customerAddressId":"{{formData.customerId}}","contact":{{item}}}' modal-scope="this" modal-url="views/purchaserAddress/contact/edit.html">修改</a></p>
                  <i class="consignee-default-label"  ng-if="purchaserAddress.defaultContactId==item.id">默认</i>
                  <i class="consignee-choise-label"   ng-if="formData.contactsId==item.id"><em class="fa fa-check color-white"></em></i>
                </li>
                <span>
                  <button class="pr-add-item-whitebg" style="min-height:136px;"
                          modal-right="700"
                          modal-data='{"customerAddressId":"{{formData.customerId}}","contact":{}}'
                          modal-scope="this"
                          modal-url="views/purchaserAddress/contact/edit.html"
                          ng-class="{'static':!purchaserAddress.contacts}">
                    <i class="fa fa-plus"></i>
                  </button>
                </span>
              </ul>
            </div>
          </div> -->
        </div>
        <!-- 收货方信息 -->
        <div class="panel pr-panel pr-fuzzy-boundary pr-panel-height mgb">
          <header class="text-n text-bold">收货方信息
            <span class="tools pull-right">
              <a href="javascript:;" class="fa fa-chevron-down" toggle-panel></a>
            </span>
          </header>
          <!-- <div class="panel-body" style="display:none;">
            <div class="mgb-l">
              <select ng-if="formData.createAt"
                      class="ipt pr-long-ipt"
                      data-placeholder="采购方名称"
                      chosen
                      width="280px"
                      ng-model="formData.customerId"
                      select-source="rest/authen/purchaserAddress/queryForSelectOption.json">
              </select>
            </div>
            <div class="consignee-info"
                 ajax-if-eval="formData.customerId"
                 ajax-url="rest/authen/purchaserAddress/get.json?id={{formData.customerId}}&t={{reloadTime}}"
                 scope-data="purchaserAddress"
                 callback="customerAddressGetCallBack(formData,purchaserAddress)"
                 ng-class="{'static': purchaserAddress.contacts}">
              <h1 class="color-9 text-n mgb">收货人信息</h1>
              <ul ng-if="formData.customerId" style="min-height:136px;">
                <li class="mgr-m mgb-m" style="min-height:136px;"  ng-repeat="item in purchaserAddress.contacts" ng-click="formData.contactsId=item.id">
                  <p class="pdb">{{item.name}} </p>
                  <p class="text-n color-6 mgb-s">{{item.prov}} {{item.city}} {{item.area}} {{item.address}} {{item.tel}}</p>
                  <p><a href="javacript:;"  modal-right="600" modal-data='{"customerAddressId":"{{formData.customerId}}","contact":{{item}}}' modal-scope="this" modal-url="views/purchaserAddress/contact/edit.html">修改</a></p>
                  <i class="consignee-default-label"  ng-if="purchaserAddress.defaultContactId==item.id">默认</i>
                  <i class="consignee-choise-label"   ng-if="formData.contactsId==item.id"><em class="fa fa-check color-white"></em></i>
                </li>
                <span>
                  <button class="pr-add-item-whitebg" style="min-height:136px;"
                          modal-right="700"
                          modal-data='{"customerAddressId":"{{formData.customerId}}","contact":{}}'
                          modal-scope="this"
                          modal-url="views/purchaserAddress/contact/edit.html"
                          ng-class="{'static':!purchaserAddress.contacts}">
                    <i class="fa fa-plus"></i>
                  </button>
                </span>
              </ul>
            </div>
          </div> -->
        </div>
        <!-- 备注 -->
        <div class="panel pr-panel pr-fuzzy-boundary pr-panel-height mgb">
          <h1>备注</h1>
          <textarea class="pr-textarea mgb-l mgt" maxlength="240" style="height:92px;" placeholder="" ng-model="formData.note"></textarea>
        </div>
        <!-- 功能按钮 -->
        <!-- <div class="pdb-xxl text-right">
          <span class="mgl">
            <a ng-if="changeFlag" href="javascript:;"
               handle-this-click
               dialog-title="确认返回?"
               dialog-content="该购需单存在未保存数据，是否保存?"
               dialog-template="pr-dialog-return.html"
               nosave-callback="goTo('#/salesOrder/query.html')"
               save-callback="submitForm('editForm','exit')">返回</a>

               <a ng-if="!changeFlag" href="#/salesOrder/query.html" >返回</a>
          </span>
          <span>
            <a ng-if="formData.orderStatus=='待处理' && formData.inputUserId==mainStatus.id"
               href="javascript:;"
               class="pr-color-red mgl"
               handle-this-click
               dialog-title="确认删除?"
               dialog-content="您确认删除这条购需单吗?"
               dialog-template="dialog-confirm.html"
               request-url="rest/authen/salesOrder/delete?id={{formData.id}}"
               call-back="$root.goTo('#/salesOrder/query.html')">删除
            </a>
          </span>
          <span class="mgl">
            <button class="pr-btn-save-glodbg" ng-disabled="!changeFlag" ng-click="submitForm('editForm','save')">保存</button>
          </span>
          <span class="mgl">
            <button ng-click="submitForm('editForm','submit')"
                    class="pr-btn-create-glodbg"
                    ng-disabled="!formData.orderMedicalNos.length ||
                                 !formData.customerId ||
                                 !formData.saleUserId ||
                                 !canSubmitForm()">生成销售单
            </button>
          </span>
        </div> -->
      </div>
    </div>
    <!-- 功能按钮 -->
    <div class="handle-btn-area relative">
      <div class="btn-area">
          <a ng-if="changeFlag" href="javascript:;" class="mgr-l"
             handle-this-click
             dialog-title="确认返回?"
             dialog-content="该购需单存在未保存数据，是否保存?"
             dialog-template="pr-dialog-return.html"
             nosave-callback="goTo('#/salesOrder/query.html')"
             save-callback="submitForm('editForm','exit')">返回购需单列表
          </a>

          <a class="mgr-l" ng-if="!changeFlag" href="#/salesOrder/query.html" >返回购需单列表</a>

          <a ng-if="formData.orderStatus=='待处理' && formData.inputUserId==mainStatus.id"
             href="javascript:;"
             class="pr-color-red mgr-l"
             handle-this-click
             dialog-title="确认删除?"
             dialog-content="您确认删除这条购需单吗?"
             dialog-template="dialog-confirm.html"
             request-url="rest/authen/salesOrder/delete?id={{formData.id}}"
             call-back="$root.goTo('#/salesOrder/query.html')">删除
          </a>

          <button class="pr-btn-save-glodbg mgr-l" ng-disabled="!changeFlag" ng-click="submitForm('editForm','save')">保存</button>

          <button ng-click="submitForm('editForm','submit')"
                  class="pr-btn-create-glodbg"
                  ng-disabled="!formData.orderMedicalNos.length ||
                               !formData.customerId ||
                               !formData.saleUserId ||
                               !canSubmitForm()">审核
          </button>
      </div>
    </div>
  </form>
</div>
