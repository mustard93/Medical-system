
<div class="content-wrapper"  ng-controller="salesOrderEditCtrl"  ajax-url="rest/authen/salesOrder/getOfEdit.json?id={{mainStatus.pageParams.id}}"  scope-data="formData" alert-error callback="getOfEditCallBack(formData)">
  <!-- 主内容头部 -->
  <div class="content-wrapper-heading">
    <h1 class="pr-title-color pr-font-24">{{!formData.id?'新建':'编辑'}}订单</h1>
  </div>
  <!-- 主内容区域 -->
  <form name="editSalesOrderForm" form-validator  parameter-body action="rest/authen/salesOrder/save.json"
            alert-error scope-error-msg="errorMsg" scope-data="formData"
            callback="goTo('#/salesOrder/confirm-order.html?id='+formData.id)"
            >
  <div class="content-wrapper-main pr-bg-white pr-border">
    <!-- 订单类型 -->
    <div class="flex-column mgt-l mgb-l pd-c-xxxxl pdt-l pdb-l bb-line">
      <div class="flex-item-2">
        <select class="select pr-select">
          <option value="普通订单">普通订单</option>
          <option value="紧急订单">紧急订单</option>
        </select>
      </div>
      <div class="flex-item-10 text-right text-s color-6 mgt">
        <span class="mgr-xl">创建时间：{{formData.createAt | date : 'yyyy-MM-dd HH:mm'}}</span>
        <span class="mgr-xl">订单状态：{{formData.orderStatus}}</span>
        <span>订单编号：{{formData.orderNo}}</span>
      </div>
    </div>
    <!-- 用户信息 -->
    <div class="pd-c-xxxxl pdb-l bb-line" >
      <span>
        <label class="pr-label mgr-l">用户名</label>

        <select ng-if="!(formData.id&&formData.customerName)"  class="ipt pr-short-ipt" data-placeholder="填写用户名" chosen  chosen-ajax ng-model="formData.customerId" select-source="rest/authen/customerAddress/queryForSelectOption.json"></select>
          <input ng-if="formData.id&&formData.customerName" type="text" class="ipt pr-short-ipt"   ng-readonly="true" ng-model="formData.customerName">
      </span>
      <span>
        <label class="pr-label mgr-l">负责人员</label>
        <select class="ipt pr-short-ipt" data-placeholder="填写负责人员" chosen default-empty="无"  ng-model="formData.saleUserId" select-source="rest/authen/user/queryForSelectOption.json">
          <option value=""></option>
        </select>
      </span>
      <span>
        <label class="pr-label mgr-l">期望到货时间</label>
        <input type="date" class="ipt pr-short-ipt" placeholder="期望到货时间" convert-to-date ng-model="formData.expectDate">
      </span>
    </div>
    <!-- 收货人信息 -->
    <div class="consignee-info pd-c-xxxxl pdt-l pdb-l bb-line"
     ajax-if="{{formData.customerId}}"  ajax-url="rest/authen/customerAddress/get.json?id={{formData.customerId}}&t={{reloadTime}}"
     scope-data="customerAddress"  callback="customerAddressGetCallBack(formData,customerAddress)">
      <h1 class="color-6 text-n mgb-l">收货人信息</h1>
      <ul ng-if="formData.customerId">

        <li class="mgr-m"  ng-repeat="item in customerAddress.contacts" ng-click="formData.contactsId=item.id">
          <p class="pdb">{{item.name}} </p>
          <p class="text-n color-6 mgb-s">{{item.address}} {{item.tel}}</p>
          <p><a href="javacript:;"  modal-right="700"  modal-right="700" modal-data='{"customerAddressId":"{{formData.customerId}}","contact":{{item}}}' modal-scope="this" modal-url="views/customerAddress/contact/edit.html">修改</a></p>

          <i class="consignee-default-label"  ng-if="customerAddress.defaultContactId==item.id">默认</i>
          <i class="consignee-choise-label"   ng-if="formData.contactsId==item.id"><em class="fa fa-check color-white"></em></i>
        </li>

        <!-- <li class="mgr-m">
          <p class="pdb">张大伟</p>
          <p class="text-n color-6 mgb-s">四川省成都市武侯区武侯大道168号四川省第三人民医院会计部 18285851010</p>
          <p><a href="">修改</a></p>
        </li> -->


        <span>
          <button class="pr-add-item-whitebg" modal-right="700" modal-data='{"customerAddressId":"{{formData.customerId}}","contact":{}}' modal-scope="this" modal-url="views/customerAddress/contact/edit.html"><i class="fa fa-plus"></i></button>
        </span>
      </ul>

    </div>
    <!-- 订单清单 -->

    <div class="order-details pd-c-xxxxl bb-line">
      <h1 class="pdt-l color-6 text-n">订单清单</h1>
      <table class="mgt-l pr-table">
        <thead>
          <th class="pr-indent-20">药械名称/生产厂家/规格</th>
          <th class="w-106 text-center">销售单位</th>
          <th class="w-106 text-center">参考单价</th>
          <th class="w-106 text-center">成交价</th>
          <th class="w-106 text-center">同批次</th>
          <th class="w-186 text-center">批次号</th>
          <th class="w-106 text-center">库存</th>
          <th class="w-150 text-center">购买数量</th>
          <th class="w-94 text-center">操作</th>
        </thead>
        <tbody  ajax-if="orderMedicalNosIdsString"
        ajax-url="rest/authen/medicalStock/countStockByIds.json?ids={{orderMedicalNosIdsString}}" scope-data="medicalStockMap" alert-error>
          <tr class="tr-interval"><td colspan="9"></td></tr>

          <tr ng-repeat="tr in formData.orderMedicalNos" ng-click="selectThis()">

            <td class="goods-name has-border pd-m" ng-init="orderMedicalNosIds.push(tr.id)">
              <div class="relative">
                <span class="goods-thumbnail inline-block"><img src="images/yaopin-1.jpg" alt=""></span>
                <span class="inline-block">
                  <p class="pdl-l mgb color-6 text-n text-bold"><span>{{tr.name}}</span></p>
                  <p class="pdl-l mgb color-9 text-n"><span>{{tr.brand}}</span></p>
                  <p class="mgt-s color-9 text-n"><span class="mgl-l">{{tr.specification||"无规格"}}</span></p>
                </span>
              </div>
            </td>
            <td class="has-border text-center">{{tr.unit}}</td>
            <td class="has-border text-center">￥{{tr.price}}</td>
            <td class="has-border text-center" >￥<input type="text" class="pr-table-input" placeholder="成交价" ng-model="tr.strike_price" ></td>
            <td class="has-border text-center">{{tr.isSameBatch}}</td>
            <td class="has-border text-center" >
              <select ng-if="tr.isSameBatch=='是'"  class="ipt pr-short-ipt" data-placeholder="批次选择"
               ng-model="tr.batchNo"  >
                <option value=""></option>
              </select>
            </td>
            <td class="has-border text-center">{{medicalStockMap[tr.relId].quantity}}</td>
            <td class="has-border pr-bg-pink text-center">
              <span class="order-goods-num flex-column">
                <i class="flex-item-1">-</i>
                <input type="text" class="flex-item-10 pr-bg-pink"  ng-model="tr.quantity">
                <i class="flex-item-1">+</i>
              </span>
              <span class="text-s pr-point-color" ng-if="medicalStockMap[tr.relId].quantity<tr.quantity"><i class="fa fa-exclamation-triangle" ></i> 本批次库存不足，此条目将由销售拆分</span>
            </td>
            <td class="has-border text-center">
              <span class="block mgb-s"><button type="button" class="pr-btn-table-glodbg">拆分</button></span>
              <span class="block"  ng-click="formData.orderMedicalNos.splice($index,1)"><a href="javascript:;"><i class="fa fa-trash-o pr-color text-l"></i></a></span>
            </td>
          </tr>


          <tr>
            <td colspan="9" class="pd-v-l">添加药械</td>
          </tr>

          <tr  ng-init="addDataItem={}"  ajax-if="{{addDataItem.relId}}"  ajax-url="rest/authen/medicalStock/get.json?id={{addDataItem.relId}}" scope-data="medical"
            callback="selectRelIdCallBack(medical)">
            <td class="has-border pd-l">
              <div class="flex-column">
                <span class="goods-thumbnail flex-item-2"><img src="images/yaopin-1.jpg" alt=""></span>
                <span class="flex-item-10">
                  <p>
                    <!-- <input type="text" class="pr-table-input" placeholder="药械名"> -->
                    <select id="addDataItem_relId" class="select select-w" data-placeholder="药械名" chosen  default-empty="药械名"
                    ng-model="addDataItem.relId"
                    select-source="rest/authen/medicalStock/queryForSelectOption.json"></select>
                  </p>
                  <p>
                    <input type="text" class="pr-table-input" placeholder="厂商名"  ng-model="medical.brand">
                  </p>
                  <p class="mgt-s">
                    <span class="mgl-l">{{addDataItem.specification||"无规格"}}</span>
                  </p>
                </span>
              </div>
            </td>
            <td class="has-border">

              {{addDataItem.unit}}
              <!-- <select class="pr-table-select">
                <option value="">单位</option>
                <option value="">盒</option>
              </select> -->
            </td>
            <td class="has-border text-center">￥{{addDataItem.price}}</td>
            <td class="has-border">
              ￥<input type="text" class="pr-table-input" placeholder="成交价" ng-model="addDataItem.strike_price" >
            </td>
            <td class="has-border text-center">

                <input type="checkbox" class="pr-table-checkbox" ng-true-value="'是'" ng-false-value="'否'"   ng-model="addDataItem.isSameBatch" />
            </td>
            <td class="has-border">
              <select ng-show="addDataItem.isSameBatch=='是'" class="pr-table-input" data-placeholder="批次选择"  ajax-if="medical.id"
               ng-model="addDataItem.batchNo"  >
                <option value=""></option>
              </select>

            </td>
            <td class="has-border text-center">
              {{medical.quantity}}
            </td>
            <td class="has-border">
              <input type="number" id="addDataItem_quantity" class="pr-table-input" ng-model="addDataItem.quantity"  ng-keydown="$event.keyCode==13&&addDataItemClick()"/>

            </td>
            <td class="fix-td-border">
              <button class="pr-add-item-glodbg color-white" type="button"  ng-click="addDataItemClick()"><i class="fa fa-plus"></i></button>
            </td>
          </tr>
        </tbody>
      </table>
      <p class="mgt-m mgb-l text-right"><a href="javascript:;">导入药械清单</a><i class=""></i></p>
    </div>
    <!-- 备注 -->
    <div class="pd-c-xxxxl bb-line">
      <h1 class="pd-v-l text-n color-6">备注</h1>
      <textarea class="pr-textarea mgb-xxl" name=""></textarea>
    </div>
    <!-- 总价 -->
    <div class="text-right pd-c-xxxxl pdb-xxl pdt-xxl">
      <span class="pr-font-24 color-9">总价：</span>
      <span class="pr-font-24 color-6">￥{{formData.totalPrice}}</span>
    </div>
    <!-- 提交按钮 -->
    <div class="pd-c-xxxxl pdb-xxl text-right">
      <span class="mgr-l"><button class="pr-btn-save-glodbg" type="submit">保存</button></span>
      <span class="mgr-l"><button  type="submit" class="pr-btn-create-glodbg">生成订单</button></span>
      <span><a href="javascript:;" ng-click="cancelThis('取消后无法回复原有数据,确认取消?', 'pr')">取消</a></span>
    </div>
  </div>
  </form>
</div>
