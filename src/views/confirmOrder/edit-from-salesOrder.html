<div class="confirm-order-edit"
     ng-controller="confirmOrderEditCtrl2"
     ajax-url="rest/authen/confirmOrder/get.json?id={{mainStatus.pageParams.id}}&businessKey={{mainStatus.pageParams.businessKey}}"
     scope-data="formData"
     callback="initFlag=true;choiseStatus=false;$root.watchFormChange('formData',this);orderMedicalNos=formData.orderMedicalNos;formData.exchangeRate='1.00';formData.thisPageTotal=0"
     alert-error>
  <form id="editForm"
        name="editForm"
        form-validator
        parameter-body
        action="rest/authen/confirmOrder/save.json"
        alert-error
        alert-ok
        scope-error-msg="errorMsg"
        scope-data="formData"
        callback="submitFormAfter();$root.watchFormChange('formData',this)">
    <!-- 头部信息 -->
    <div class="content-wrapper-heading pdb-m mgb-l relative clearfix">
      <p class="pdb-s pdt-s mgb-l crumbs pd-c-xl">销售中心 > <em class="color-custom-orange">销售单</em></p>
      <!-- 标题 -->
      <div class="pd-c-xl">
        <div class="pos-rel-tl inline-block fl-l">
          <h1 class="pr-font-20 color-black">销售单</h1>
          <p class="mgt-l text-n color-3 text-bold">{{formData.customerName}}</p>
        </div>
      </div>
    </div>
    <!-- 药械列表 -->
    <div class="content-wrapper">

      <div class="panel pr-panel pr-fuzzy-boundary pr-panel-height mgb-l pd-n">
        <!-- 单据信息 -->
        <div class="flex-column color-9 pd-c-l pdt-m pdb-m bb-dashed-line">
          <div class="flex-item-6">
            <span class="mgr">单据编号：<em class="color-3">{{formData.orderNo}}</em></span>
            <span class="mgr">制单人：<em class="color-3">{{formData.inputUser.n}}</em></span>
            <span class="mgr">审核人：<em class="color-3">暂无</em></span>
          </div>
          <div class="flex-item-6 text-right">
            <span class="mgr">录单日期：<em class="color-3">{{formData.createAt | date:'yyyy-MM-dd'}}</em></span>
            <span class="mgr">状态：<em class="color-3">{{formData.orderStatus}}</em></span>
          </div>
        </div>
        <!-- 类别选择 -->
        <div class="pd-c-l pdt-m pdb-m color-9">
          <span class="mgr">销售部门：
            <select class="ipt pr-short-ipt color-3" style="width:90px;"
                    data-placeholder=" "
                    chosen
                    ng-model="formData.salesDepartmentId"
                    select-source="rest/authen/department/queryForSelectOption">
            </select>
          </span>
          <span class="mgr">业务人员：
            <select class="ipt pr-short-ipt color-3" style="width:90px;"
                    data-placeholder=" "
                    chosen
                    ng-model="formData.saleUserId"
                    select-source="rest/authen/organizationAndUser/queryForSelectOption?departmentId={{formData.salesDepartmentId}}">
            </select>
          </span>
          <span class="mgr">业务类型：
            <select class="ipt pr-short-ipt color-3" style="width:90px;"
                    data-placeholder=" "
                    chosen
                    ng-model="formData.orderBusinessType"
                    select-source="rest/index/queryBasicdataForSelectOption?basicDataType=Order_OrderBusinessType">
            </select>
          </span>
          <span class="mgr">销售类型：
            <select class="ipt pr-short-ipt color-3" style="width:90px;"
                    data-placeholder=" "
                    chosen
                    ng-model="formData.salesType"
                    select-source="rest/baseData/queryForSelectOptionByType?type=销售类型">
            </select>
          </span>
          <span class="mgr">付款条件：
            <select class="ipt pr-short-ipt color-3" style="width:90px;"
                    data-placeholder=" "
                    chosen
                    ng-model="formData.paymentType"
                    select-source="rest/index/queryBasicdataForSelectOption?basicDataType=Order_PaymentType">
            </select>
          </span>
          <span class="mgr">币种：
            <select class="ipt pr-short-ipt color-3" style="width:90px;"
                    data-placeholder=" "
                    chosen
                    ng-model="formData.currencyType"
                    select-source="rest/index/queryBasicdataForSelectOption?basicDataType=Order_CurrencyType">
            </select>
          </span>
          <span class="mgr">汇率：<em class="color-6">1.00</em>
          </span>
          <span class="mgr">预发货日期：
            <input type="text"
                   datepicker
                   class="ipt pr-short-ipt color-3"
                   style="width:90px;"
                   placeholder=""
                   ng-readonly="true"
                   ng-model="formData.expectDate" />
          </span>
        </div>
        <!-- 商品列表 -->
        <div class="">
          <div class="">
            <table class="table pr-table pr-new-table mgb-n">
              <thead>
                <tr>
                  <th class="text-center w-50">
                    <label for=""><input type="checkbox" ng-model="choiseStatus" ng-click="isChoiseAll(choiseStatus)"></label>
                  </th>
                  <th class="text-center">商品编号</th>
                  <th>商品全名</th>
                  <th class="text-center">规格/型号</th>
                  <th class="text-center">单位</th>
                  <th class="text-center">数量</th>
                  <th class="text-center w-110">批号要求</th>
                  <th ng-if="formData.orderBusinessType=='普通销售'" class="text-center w-160">生产批号/灭菌批号</th>
                  <th class="text-center">报价</th>
                  <th class="text-center">税率</th>
                  <th class="text-center">折扣额</th>
                  <th class="text-center">折扣率</th>
                  <th class="text-center">含税单价</th>
                  <th class="text-center">无税单价</th>
                  <th class="text-center">无税金额</th>
                  <th class="text-center">税额</th>
                  <th class="text-center">价税合计</th>
                </tr>
              </thead>
              <tbody ng-if="formData.orderBusinessType=='普通销售'">
                <tr ng-repeat="item in orderMedicalNos" ng-controller="ConfirmOrderMedicalController">
                  <td class="text-center w-50">
                    <label for=""><input type="checkbox" ng-model="item.handleFlag" ng-change="handleThischoise(item)"></label>
                  </td>
                  <td class="text-center">{{item.code}}</td>
                  <td>{{item.name}}</td>
                  <td class="text-center">{{item.specificationAndModelType}}</td>
                  <td class="text-center">{{item.unit}}</td>
                  <td class="text-center">{{item.planQuantity}}</td>
                  <td class="text-center">
                    <select class="select pr-select pr-select-sm text-left"
                            chosen
                            ng-model="item.batchRequirement"
                            select-source="rest/index/queryBasicdataForSelectOption?basicDataType=Basic_BatchRequirementStatus">
                    </select>
                  </td>
                  <td class="text-center">
                    <div ng-repeat="stockBatchsItem in item.stockBatchs" class="mgb">
                      <select class="select pr-select pr-select-sm text-left"
                              chosen
                              default-empty
                              data-placeholder=" "
                              select-data="selectData"
                              suffix-connection="/"
                              suffix-key="note.salesQuantity"
                              ng-model="stockBatchsItem.batchNumber"
                              callback="choiseProductionBatch(item,stockBatchsItem,selectData);"
                              callback-filter-return-data="getProductionBatchValueArray(item.stockBatchs)"
                              select-source="rest/authen/medicalStock/queryStockBatchForSelectOption?relMedicalStockId={{item.relId}}">
                      </select>
                      <p class="mgt-s text-right relative" ng-if="stockBatchsItem.batchNumber">
                        <input type="number"
                               class="ipt pr-short-ipt color-6 text-right"
                               ng-model="stockBatchsItem.quantity"
                               data-content="该批号总量只有：{{selectData.note.salesQuantity}}"
                               invalid-popover="{{selectData&&(stockBatchsItem.quantity>selectData.note.salesQuantity)}}" />
                               <span class="circle-s" ng-click="item.stockBatchs.splice($index,1)"><i class="fa fa-times-circle"></i></span>
                      </p>
                      <!-- <p class="text-right color-red pdr-s mgt-s" ng-if="selectData&&(stockBatchsItem.quantity>selectData.note.salesQuantity)">{{selectData&&(stockBatchsItem.quantity>selectData.note.salesQuantity)}}缺货：{{stockBatchsItem.quantity-selectData.note.salesQuantity}}</p> -->
                    </div>
                    <p class="text-right color-red pdr-s mgt-s" ng-if="item.planQuantity>item.quantity">待选择：{{item.planQuantity-item.quantity}}</p>
                  </td>
                  <td class="text-right">{{item.strike_price | currency:'￥'}}</td>
                  <td class="text-right">{{item.taxRate}}%</td>
                  <td class="text-right">￥{{item.discountPrice | number:2}}</td>
                  <td class="text-right">{{item.discountRate | number:2}}%</td>
                  <td class="text-right">￥{{$root.saleOrderUtils.getHanShuiDanJian(item) | number:2}}</td>
                  <td class="text-right">￥{{$root.saleOrderUtils.getWuSuiDanJian(item) | number:2}}</td>
                  <td class="text-right">￥{{$root.saleOrderUtils.getWuSuiJinE(item) | number:2}}</td>
                  <td class="text-right">￥{{$root.saleOrderUtils.getSuiE(item) | number:2}}</td>
                  <td class="text-right">￥{{$root.saleOrderUtils.getJiaSuiHeJi(item) | number:2}}</td>
                </tr>

              </tbody>
              <tbody ng-if="formData.orderBusinessType=='直运销售'">
                <tr ng-repeat="item in orderMedicalNos" ng-controller="ConfirmOrderMedicalController">
                  <td class="text-center w-50">
                    <label for=""><input type="checkbox" ng-model="item.handleFlag"></label>
                  </td>
                  <td class="text-center">{{item.code}}</td>
                  <td>{{item.name}}</td>
                  <td class="text-center">{{item.specificationAndModelType}}</td>
                  <td class="text-center">{{item.unit}}</td>
                  <td class="text-center">{{item.planQuantity}}</td>
                  <td class="text-center">
                    <select class="select pr-select pr-select-sm text-left"
                            chosen
                            ng-model="item.batchRequirement"
                            select-source="rest/index/queryBasicdataForSelectOption?basicDataType=Basic_BatchRequirementStatus">
                    </select>
                  </td>
                  <td class="text-center">{{item.price | currency:'￥'}}</td>
                  <td class="text-center">{{item.taxRate}}%</td>
                  <td class="text-center">￥{{item.discountPrice | number:2}}</td>
                  <td class="text-center">{{item.discountRate}}%</td>
                  <td class="text-center">￥{{$root.saleOrderUtils.getHanShuiDanJian(item) | number:2}}</td>
                  <td class="text-center">￥{{$root.saleOrderUtils.getWuSuiDanJian(item) | number:2}}</td>
                  <td class="text-center">￥{{$root.saleOrderUtils.getWuSuiJinE(item, formData.orderBusinessType) | number:2}}</td>
                  <td class="text-center">￥{{$root.saleOrderUtils.getSuiE(item, formData.orderBusinessType) | number:2}}</td>
                  <td class="text-center">￥{{$root.saleOrderUtils.getJiaSuiHeJi(item, formData.orderBusinessType) | number:2}}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- 其他信息 -->
      <div class="relative">
        <!-- 收货方信息 -->
        <address-manage-component compnent-title="收货方信息"
                                  request-url="rest/authen/customerAddress/get.json"
                                  request-data-id="{{formData.customerId}}"
                                  scope-data-prefix="customer"
                                  form-data="formData"
                                  modify-modal-url="views/customerAddress/contact/edit.html"
                                  modify-modal-title="编辑收货方信息"
                                  create-modal-url="views/customerAddress/contact/edit.html"
                                  create-modal-title="添加收货方信息"
                                  create-address-type="销售"
                                  set-default-address-requesturl="rest/authen/customerAddress/contact/setDefaultContactId"
                                  del-this-address-requesturl="rest/authen/customerAddress/contact/delete">
        </address-manage-component>

        <!-- 发货方信息 -->
        <address-manage-component compnent-title="发货方信息"
                                  request-url="rest/authen/invoicesAddress/get.json"
                                  scope-data-prefix="invoices"
                                  form-data="formData"
                                  modify-modal-url="views/invoicesAddress/contact/edit.html"
                                  modify-modal-title="编辑发货方信息"
                                  create-modal-url="views/invoicesAddress/contact/edit.html"
                                  create-modal-title="添加发货方信息"
                                  create-address-type="销售"
                                  set-default-address-requesturl="rest/authen/invoicesAddress/contact/setDefaultContactId"
                                  del-this-address-requesturl="rest/authen/invoicesAddress/contact/delete">
        </address-manage-component>
        <!-- 备注 -->
        <div class="panel pr-panel pr-fuzzy-boundary pr-panel-height mgb-l">
          <h1 class="text-bold color-3">备注</h1>
          <textarea class="pr-textarea mgt" maxlength="240" style="height:92px;" placeholder="" ng-model="formData.note"></textarea>
        </div>
      </div>
    </div>
    <!-- 流程图 -->

    <!-- 流程图 -->
  <business-flow-show business-key="{{formData.id}}" business-type="销售单"></business-flow-show>

    <!-- 功能按钮 -->
    <div class="handle-btn-area">
      <div class="btn-area" style="background:rgba(54,48,44,0.30);">
        <a ng-if="changeFlag" href="javascript:;" class="mgr-l"
           handle-this-click
           dialog-title="确认返回?"
           dialog-content="该销售单存在未保存数据，是否保存?"
           dialog-template="pr-dialog-return.html"
           nosave-callback="goTo('#/confirmOrder/query.html')"
           save-callback="submitForm('editForm','exit')">返回销售单
        </a>

        <a class="mgr-l" ng-if="!changeFlag" ng-href="#/confirmOrder/query.html" >返回销售单</a>

        <a ng-if="formData.orderStatus=='待审核' && formData.inputUserId==mainStatus.id"
           href="javascript:;"
           class="pr-color-red mgr"
           handle-this-click
           dialog-title="确认删除?"
           dialog-content="您确认删除这条购需单吗?"
           dialog-template="dialog-confirm.html"
           request-url="rest/authen/salesOrder/delete?id={{formData.id}}"
           call-back="$root.goTo('#/salesOrder/query.html')">删除
        </a>

        <button
                type="button"
                class="pr-btn-save-glodbg mgr"
                ng-disabled="!changeFlag"
                ng-click="submitForm('editForm','save')">保存
        </button>

        <button
                type="button"
                class="pr-btn-save-glodbg mgr"
                ng-click="submitForm('editForm','print')">打印预览
        </button>


        <button ng-if="formData.orderBusinessType=='普通销售'&&formData.orderStatus=='未提交'"
                type="button"
                class="pr-btn-save-glodbg mgr"
                ng-disabled="($root.utils.sumTotalByArrayMul(formData.orderMedicalNos,['price','quantity'],'handleFlag',true)<0) ||
                             ($root.utils.sumTotalByArrayMul(formData.orderMedicalNos,['price','quantity'],'handleFlag',true)>100000)"
                ng-click="submitForm('editForm','submit')">提交
        </button>

        <button ng-if="formData.orderBusinessType=='直运销售'&&formData.orderStatus=='未提交'"
                type="button"
                class="pr-btn-save-glodbg mgr"
                ng-disabled="$root.utils.sumTotalByArrayMul(formData.orderMedicalNos,['price','quantity'],'handleFlag',true)>100000"
                ng-click="submitForm('editForm','submit')">提交
        </button>

      </div>
      <div ng-if="formData.orderBusinessType=='普通销售'" class="price-area relative fl-r mgr-l" style="height:100%;line-height:3.3;font-size:18px;color:#c7a77b;">总计：
        <em class="color-white"
            invalid-popover
            popover-show="$root.utils.sumTotalByArrayMul(orderMedicalNos,['price','quantity'],'handleFlag',true)>100000"
            popover-options='{"content": "每单总计金额不能超过10万", "placement": "top", "trigger": "manual"}'>
            ￥{{$root.utils.sumTotalByArrayMul(orderMedicalNos,['price','quantity'],"handleFlag",true) | number:2}}
        </em>
      </div>

      <div ng-if="formData.orderBusinessType=='直运销售'"
           class="price-area relative fl-r mgr-l"
           style="height:100%;line-height:3.3;font-size:18px;color:#c7a77b;">总计：
        <em class="color-white">
          ￥{{$root.utils.sumTotalByArrayMul(orderMedicalNos,['price','planQuantity']) | number:2}}
        </em>
      </div>
    </div>
  </form>
</div>
